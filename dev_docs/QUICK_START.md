# IPAMS 主机信息采集快速开始

## 功能概述

IPAMS现在支持**主机信息自动采集**功能，可以在扫描发现IP后，通过Ansible和VMware API收集主机的详细信息。

## ✅ 最新更新（2025-11-03）

### 凭证管理增强
1. **查看详情**：忘记密码可查看明文用户名和密码
2. **查看绑定**：显示凭证关联的所有主机
3. **测试连接**：支持指定主机IP测试SSH/WinRM连接
4. **一键复制**：用户名密码一键复制到剪贴板

### 主机信息管理增强
1. **自动创建**：认领IP后自动创建HostInfo
2. **绑定凭证**：支持为每个主机绑定多个凭证
3. **可视化详情**：硬件、网络、磁盘等信息展示
4. **批量导出**：Excel导出支持模板和字段选择

## 完整流程

### 第一步：网络扫描（已完成）
- ✅ 执行网络扫描
- ✅ 系统自动发现活跃主机
- ✅ IP记录自动创建

### 第二步：认领IP（必需）
在 **主机管理** 页面认领IP：
- 选择要认领的IP
- 填写设备信息（设备名、类型、制造商等）
- 提交认领

**认领后的IP才能进行信息采集**

### 第三步：创建凭证（必需）
在 **凭证管理** 页面创建凭证：

1. 点击"添加凭证"
2. 填写凭证信息：
   ```
   凭证名称: Linux Production Server
   凭证类型: Linux
   用户名: root
   密码: your-password（自动加密存储）
   ```
3. 保存凭证

**支持的凭证类型：**
- **Linux**: SSH用户名/密码或私钥
- **Windows**: WinRM用户名/密码
- **VMware**: vCenter/ESXi管理员账号

### 第四步：绑定凭证到主机
在 **主机信息** 页面：

1. 进入主机信息页面（`/hosts`）
2. 所有已认领的IP会自动出现在列表中
3. 点击某个主机的"绑定凭证"按钮
4. 选择对应的凭证
5. 确认绑定

**一个主机可以绑定多个凭证**

### 第五步：触发信息采集
在 **主机信息** 页面：

1. **单个采集**：点击某个主机的"采集"按钮
2. **批量采集**：
   - 勾选多个主机
   - 点击"批量采集"按钮
   - 系统并发执行

### 第六步：查看采集结果
采集完成后：
- 点击"查看详情"查看完整信息
- 包括：操作系统、CPU、内存、磁盘、网络等
- 所有数据实时更新

### 第七步：导出数据（可选）
1. 勾选需要导出的主机
2. 点击"批量导出"
3. 选择导出字段或使用预设模板
4. 下载Excel文件

## 核心概念

### IP vs HostInfo
- **IP**: 网络层概念，只包含IP地址和基本设备信息
- **HostInfo**: 主机层概念，包含详细的硬件、软件、网络配置

### 数据流程
```
扫描发现IP → 认领IP → 创建HostInfo → 绑定凭证 → 采集信息 → 查看/导出
```

### 为什么需要认领IP？
- IP认领后状态变为 `active`
- 只有 `active` 状态的IP才能进行信息采集
- 确保只有授权的主机被采集

### 为什么需要绑定凭证？
- 凭证用于采集时的身份验证
- 一个主机可以绑定多个凭证
- 凭证加密存储在数据库中

## 常见问题

### Q: 为什么主机信息页面是空的？
**A**: 需要先认领IP。只有已认领的IP才会自动创建HostInfo记录。

### Q: 如何查看凭证的用户名和密码？
**A**: 在凭证管理页面，点击"查看详情"按钮，系统会显示解密后的用户名和密码，可以一键复制。

### Q: 如何查看凭证绑定了哪些主机？
**A**: 在凭证管理页面，点击"查看绑定"按钮，可以查看该凭证绑定的所有主机列表。

### Q: 凭证测试连接功能有什么用？
**A**: 测试连接功能可以验证凭证是否正确。选择凭证后点击"测试连接"，输入主机IP地址，系统会立即验证SSH/WinRM连接是否成功。

### Q: 如何判断采集是否成功？
**A**: 查看采集状态：
- `pending`: 待采集
- `collecting`: 采集中
- `success`: 采集成功
- `failed`: 采集失败（查看错误信息）

### Q: 支持哪些操作系统？
**A**: 
- Linux: 所有支持SSH的系统
- Windows: 需要启用WinRM服务
- VMware: vCenter 6.0+

### Q: 批量采集支持多少主机？
**A**: 默认并发5个主机，可在配置中调整 `COLLECTION_MAX_CONCURRENT`

## 故障排查

### 凭证绑定失败
- 检查凭证是否正确创建
- 确认凭证类型与主机类型匹配

### 采集失败
- 检查网络连通性（ping/telnet）
- 验证凭证是否正确
- 查看错误详情

### Linux采集失败
- 确认SSH服务运行
- 检查用户名密码
- 如果使用私钥，确认格式正确

### Windows采集失败
- 确认WinRM已启用
- 检查防火墙设置
- 验证用户名密码

## 最佳实践

1. **先小批量测试**: 先测试1-2个主机，确认凭证正确后批量采集
2. **凭证管理**: 为不同环境创建不同的凭证
3. **定期更新**: 定期重新采集获取最新信息
4. **权限最小化**: 使用最小权限账号
5. **备份数据**: 定期导出重要主机信息

## API端点

### 凭证管理
- `GET /api/v1/credential` - 获取凭证列表
- `POST /api/v1/credential` - 创建凭证
- `GET /api/v1/credential/<id>` - 获取凭证详情
- `GET /api/v1/credential/<id>/detail` - 获取凭证详情（包含解密后的密码）
- `GET /api/v1/credential/<id>/bindings` - 获取凭证绑定的主机列表
- `POST /api/v1/credential/<id>/batch-bind` - 批量绑定主机到凭证
- `POST /api/v1/credential/<id>/batch-unbind` - 批量解绑主机
- `PUT /api/v1/credential/<id>` - 更新凭证
- `DELETE /api/v1/credential/<id>` - 删除凭证
- `POST /api/v1/credential/<id>/test` - 测试凭证连接（支持指定host_ip参数）

### 主机管理
- `GET /api/v1/host` - 获取主机列表
- `GET /api/v1/host/<id>` - 获取主机详情
- `POST /api/v1/host/<id>/bind-credential` - 绑定凭证
- `DELETE /api/v1/host/<id>/unbind-credential` - 解绑凭证
- `POST /api/v1/host/<id>/collect` - 单个采集（支持自定义凭证）
- `POST /api/v1/host/batch-collect` - 批量采集
- `POST /api/v1/host/batch-bind` - 批量绑定凭证
- `POST /api/v1/host/batch-unbind` - 批量解绑凭证
- `POST /api/v1/host/export` - 导出数据

